"use strict";var dependencies;dependencies=["LocalStorageModule"],angular.module("angular-advanced-poller",dependencies),angular.module("angular-advanced-poller").factory("ChainedPollerJob",["localStorageService","PollerJobRunner",function(a,b){var c;return c=function(){function c(){}return c.prototype.validate=function(){if(!this.name)throw"Job must have a name";if(!this.priority)throw"Job must have an integer priority";if(!_.isFunction(this.run))throw"You must use 'run' to specify what to do";if(this.stop&&!_.isFunction(this.stop))throw"You must provide a function to 'stop'";if(!this.chainTo)throw"You must tell what job to run this after using 'chainTo'";if(!moment.isDuration(this.timeout))throw"Timeout must be a moment duration"},c.prototype.isOverdue=function(){return!this.runner&&this.nextRun&&(moment().isAfter(this.nextRun)||moment().isSame(this.nextRun))},c.prototype.initialize=function(){var b;return b=a.get("poller.job.nextRun."+this.name),b&&(this.nextRun=moment(b)),this},c.prototype.makeOverdue=function(){return this.nextRun=moment(),this._saveRuntime(),this},c.prototype.getTimeout=function(){return this.timeout},c.prototype._saveRuntime=function(){return a.set("poller.job.nextRun."+this.name,this.nextRun.toISOString())},c.prototype.cancel=function(){return null!=this.runner&&this.runner.stop(),this.runner=null,null!=this.stop?this.stop():void 0},c.prototype.execute=function(){return this._endPreviousRunner(),this.runner=new b(this),this.runner.run().then(function(b){return function(){return a.remove("poller.job.nextRun."+b.name)}}(this))["finally"](function(a){return function(){a.runner=null}}(this))},c.prototype._endPreviousRunner=function(){return this.runner&&this.runner.running?(console.debug("Runner for job "+this.name+" is still running."),this.runner.stop()):void 0},c}()}]),angular.module("angular-advanced-poller").factory("PollerJob",["localStorageService","PollerJobRunner",function(a,b){var c;return c=function(){function c(){}return c.prototype.validate=function(){if(!this.name)throw"Job must have a name";if(!this.priority)throw"Job must have an integer priority";if(!_.isFunction(this.run))throw"You must use 'run' to specify what to do";if(this.stop&&!_.isFunction(this.stop))throw"You must provide a function to 'stop'";if(!moment.isDuration(this.interval))throw"Interval must be a moment duration";if(this.timeout&&!moment.isDuration(this.timeout))throw"Timeout must be a moment duration";if(this.randomOffset&&!moment.isDuration(this.randomOffset))throw"Random offset must be a duration"},c.prototype.getNextInterval=function(){return null!=this.randomOffset?this.interval.asMilliseconds()+Math.ceil(Math.random()*this.randomOffset.asMilliseconds()):this.interval.asMilliseconds()},c.prototype.initialize=function(){return this.nextRun=moment(a.get("poller.job.nextRun."+this.name)||new Date),this},c.prototype.isOverdue=function(){return!this.runner&&(moment().isAfter(this.nextRun)||moment().isSame(this.nextRun))},c.prototype.makeOverdue=function(){return this.nextRun=moment(),this._saveRuntime(),this},c.prototype.getTimeout=function(){return this.timeout||this._intervalOr30Seconds()},c.prototype._intervalOr30Seconds=function(){return _.min([this.interval,moment.duration({seconds:30})],function(a){return a.asMilliseconds()})},c.prototype.saveNextRun=function(){return this.nextRun=moment().add(this.getNextInterval()),this._saveRuntime(),this},c.prototype._saveRuntime=function(){return a.set("poller.job.nextRun."+this.name,this.nextRun.toISOString())},c.prototype.cancel=function(){return null!=this.runner&&this.runner.stop(),this.runner=null,null!=this.stop?this.stop():void 0},c.prototype.execute=function(){return this._endPreviousRunner(),this.runner=new b(this),this.runner.run().then(function(a){return function(b){return a.saveNextRun(),b}}(this))["finally"](function(a){return function(){a.runner=null}}(this))},c.prototype._endPreviousRunner=function(){return this.runner&&this.runner.running?(console.debug("Runner for job "+this.name+" is still running."),this.runner.stop()):void 0},c}()}]);var __slice=[].slice;angular.module("angular-advanced-poller").factory("PollerJobRunner",["$q","$timeout",function(a,b){var c;return c=function(){function c(a){this.job=a,this.running=!0}return c.prototype.run=function(){var b;return console.debug("Running job "+this.job.name),this.promise=a.defer(),b=this._run(),this._scheduleTimeout(),b.then(function(a){return function(){var b,c;return b=1<=arguments.length?__slice.call(arguments,0):[],(c=a.promise).resolve.apply(c,b)}}(this))["catch"](function(a){return function(){var b,c;return b=1<=arguments.length?__slice.call(arguments,0):[],(c=a.promise).reject.apply(c,b)}}(this))["finally"](function(a){return function(){a._cancelTimeout()}}(this)),this.promise.promise["finally"](function(a){return function(){return a.running=!1}}(this))},c.prototype.stop=function(){return console.debug("Stopping job "+this.job.name),this._cancelTimeout(),this.promise.resolve("Stopped")},c.prototype._run=function(){var b;return b=this.job.run(),b&&_.isFunction(b["finally"])?b:a.when(b)},c.prototype._timeout=function(){return console.debug("Timed out job "+this.job.name),this.promise.reject("TimedOut")},c.prototype._scheduleTimeout=function(){return this.timeoutPromise=b(function(a){return function(){return a.timeoutPromise=b(_.bind(a._timeout,a),a.job.getTimeout().asMilliseconds())}}(this),0)},c.prototype._cancelTimeout=function(){return this.timeoutPromise&&b.cancel(this.timeoutPromise),this.timeoutPromise=null},c}()}]);var __slice=[].slice;angular.module("angular-advanced-poller").service("PollerScheduler",["PollerJob","ChainedPollerJob","$timeout","$rootScope","$q",function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B;t=[],o=[],p=null,u=4,v=100,f=function(a,b){var c;if(s(a.name))throw"A job of name "+a.name+" is already registered";return c=new b,_.defaults(c,a),c.initialize(),c.validate(),t.push(c),A(),c},r=function(a){return function(){return i(a),o=_(o).without(a),n()}},i=function(a){return d.$broadcast("poller.job."+a.name+".finish")},j=function(a){return d.$broadcast("poller.job."+a.name+".start")},g=function(a){return function(){var b;return b=1<=arguments.length?__slice.call(arguments,0):[],d.$broadcast.apply(d,["poller.job."+a.name+".success"].concat(__slice.call(b)))}},h=function(a){return function(){var b;return b=1<=arguments.length?__slice.call(arguments,0):[],d.$broadcast.apply(d,["poller.job."+a.name+".failure"].concat(__slice.call(b)))}},z=function(a,b,c){return a.$on("poller.job."+b.name+".success",c)},w=function(a,b,c){return a.$on("poller.job."+b.name+".failure",c)},y=function(a,b,c){return a.$on("poller.job."+b.name+".start",c)},x=function(a,b,c){return a.$on("poller.job."+b.name+".finish",c)},l=function(){var a;return a=moment(),_(t).chain().map(function(b){return Math.abs((b.nextRun||a).diff(a))}).min().value()},k=function(){var a;return _(t).any(function(a){return a.isOverdue()})?v:(a=l(),1/0===a&&(a=0),_.max([v,a]))},n=function(){var a,b;if(p)for(b=_(t).filter(function(a){return a.isOverdue()}),b.length>0&&console.debug(""+b.length+" jobs are ready at "+moment().toISOString());o.length<u&&b.length>0;)a=b.shift(),o.push(a),j(a),a.execute().then(g(a),h(a))["finally"](r(a))},A=function(){return t=_(t).sortBy("priority")},m=function(){return p=c(m,k()),n()},B=function(){return _(o).invoke("cancel")},s=function(a){return null!=_(t).findWhere({name:a})},q=function(a){var b;if(b=_(t).findWhere({name:a}),!b)throw"Job "+a+" is not a known job";return b},this.addJob=function(b){f(b,a)},this.chainJob=function(a){var c;return c=f(a,b),c.scope=d.$new(),this.whenSucceeded(c.chainTo,c.scope,function(){return console.debug("Chained job "+c.name+" will now execute"),c.makeOverdue()})},this.onNextRunOf=function(a){var b,c,f;return c=q(a),b=d.$new(!0),f=e.defer(),z(b,c,function(){var a,b;return b=arguments[0],a=2<=arguments.length?__slice.call(arguments,1):[],f.resolve.apply(f,a)}),w(b,c,function(){var a,b;return b=arguments[0],a=2<=arguments.length?__slice.call(arguments,1):[],f.reject.apply(f,a)}),f.promise["finally"](function(){return b.$destroy()}),f.promise},this.whenStarted=function(a,b,c){var d;return d=q(a),y(b,d,c)},this.whenSucceeded=function(a,b,c){var d;return d=q(a),z(b,d,c)},this.whenFailed=function(a,b,c){var d;return d=q(a),w(b,d,c)},this.whenFinished=function(a,b,c){var d;return d=q(a),x(b,d,c)},this.runNow=function(a){var b;b=q(a),b.makeOverdue(),n()},this.start=function(){console.debug("AdvancedPoller starting"),A(),m(),console.debug("AdvancedPoller started")},this.stop=function(){console.debug("AdvancedPoller stopping."),B(),p&&c.cancel(p),p=null,d.$$phase||d.$digest(),o=[],console.debug("AdvancedPoller stopped.")},this.setConcurrency=function(a){u=a},this.clearJobs=function(){if(null!=p)throw"Must be stopped to clear jobs";t=[]}}]);