"use strict";var dependencies;dependencies=["LocalStorageModule"],angular.module("angular-advanced-poller",dependencies),angular.module("angular-advanced-poller").factory("PollerJob",["localStorageService","PollerJobRunner",function(a,b){var c;return c=function(){function c(){}return c.prototype.validate=function(){if(!this.name)throw"Job must have a name";if(!this.priority)throw"Job must have an integer priority";if(!_.isFunction(this.run))throw"You must use 'run' to specify what to do";if(this.stop&&!_.isFunction(this.stop))throw"You must provide a function to 'stop'";if(!moment.isDuration(this.interval))throw"Interval must be a moment duration";if(this.timeout&&!moment.isDuration(this.timeout))throw"Timeout must be a moment duration";if(this.randomOffset&&!moment.isDuration(this.randomOffset))throw"Random offset must be a duration"},c.prototype.getNextInterval=function(){return null!=this.randomOffset?this.interval.asMilliseconds()+Math.ceil(Math.random()*this.randomOffset.asMilliseconds()):this.interval.asMilliseconds()},c.prototype.initialize=function(){return this.nextRun=moment(a.get("poller.job.nextRun."+this.name)||new Date),this},c.prototype.isOverdue=function(){return moment().isAfter(this.nextRun)||moment().isSame(this.nextRun)},c.prototype.makeOverdue=function(){return this.nextRun=moment(),this._saveRuntime(),this},c.prototype.getTimeout=function(){return this.timeout||this._intervalOr30Seconds()},c.prototype._intervalOr30Seconds=function(){return _.min([this.interval,moment.duration({seconds:30})],function(a){return a.asMilliseconds()})},c.prototype.saveNextRun=function(){return this.nextRun=moment().add(this.getNextInterval()),this._saveRuntime(),this},c.prototype._saveRuntime=function(){return a.set("poller.job.nextRun."+this.name,this.nextRun.toISOString())},c.prototype.cancel=function(){return null!=this.runner&&this.runner.stop(),this.runner=null,null!=this.stop?this.stop():void 0},c.prototype.execute=function(){return this._endPreviousRunner(),this.saveNextRun(),this.runner=new b(this),this.runner.run()},c.prototype._endPreviousRunner=function(){return this.runner&&this.runner.running?(console.debug("Runner for job "+this.name+" is still running."),this.runner.stop()):void 0},c}()}]);var __slice=[].slice;angular.module("angular-advanced-poller").factory("PollerJobRunner",["$q","$timeout",function(a,b){var c;return c=function(){function c(a){this.job=a,this.running=!0}return c.prototype.run=function(){var b;return console.debug("Running job "+this.job.name),this.promise=a.defer(),b=this._run(),this._scheduleTimeout(),b.then(function(a){return function(){var b,c;return b=1<=arguments.length?__slice.call(arguments,0):[],(c=a.promise).resolve.apply(c,b)}}(this))["catch"](function(a){return function(){var b,c;return b=1<=arguments.length?__slice.call(arguments,0):[],(c=a.promise).reject.apply(c,b)}}(this))["finally"](function(a){return function(){a._cancelTimeout()}}(this)),this.promise.promise["finally"](function(a){return function(){return a.running=!1}}(this))},c.prototype.stop=function(){return console.debug("Stopping job "+this.job.name),this._cancelTimeout(),this.promise.resolve("Stopped")},c.prototype._run=function(){var b;return b=this.job.run(),b&&_.isFunction(b["finally"])?b:a.when(b)},c.prototype._timeout=function(){return console.debug("Timed out job "+this.job.name),this.promise.reject("TimedOut")},c.prototype._scheduleTimeout=function(){return this.timeoutPromise=b(function(a){return function(){return a.timeoutPromise=b(_.bind(a._timeout,a),a.job.getTimeout().asMilliseconds())}}(this),0)},c.prototype._cancelTimeout=function(){return this.timeoutPromise&&b.cancel(this.timeoutPromise),this.timeoutPromise=null},c}()}]);var __slice=[].slice;angular.module("angular-advanced-poller").service("PollerScheduler",["PollerJob","$timeout","$rootScope","$q",function(a,b,c,d){var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A;s=[],m=[],n=null,t=4,u=100,r=function(b){var c;if(c=new a,q(b.name))throw"A job of name "+b.name+" is already registered";return _.defaults(c,b),c.initialize(),c},p=function(a){return function(){return g(a),m=_(m).without(a),l()}},g=function(a){return c.$broadcast("poller.job."+a.name+".finish")},h=function(a){return c.$broadcast("poller.job."+a.name+".start")},e=function(a){return function(){var b;return b=1<=arguments.length?__slice.call(arguments,0):[],c.$broadcast.apply(c,["poller.job."+a.name+".success"].concat(__slice.call(b)))}},f=function(a){return function(){var b;return b=1<=arguments.length?__slice.call(arguments,0):[],c.$broadcast.apply(c,["poller.job."+a.name+".failure"].concat(__slice.call(b)))}},y=function(a,b,c){return a.$on("poller.job."+b.name+".success",c)},v=function(a,b,c){return a.$on("poller.job."+b.name+".failure",c)},x=function(a,b,c){return a.$on("poller.job."+b.name+".start",c)},w=function(a,b,c){return a.$on("poller.job."+b.name+".finish",c)},j=function(){var a;return a=moment(),_(s).chain().map(function(b){return Math.abs((b.nextRun||a).diff(a))}).min().value()},i=function(){var a;return _(s).any(function(a){return a.isOverdue()})?u:(a=j(),1/0===a&&(a=0),_.max([u,a]))},l=function(){var a,b;if(n)for(b=_(s).filter(function(a){return a.isOverdue()}),b.length>0&&console.debug(""+b.length+" jobs are ready at "+moment().toISOString());m.length<t&&b.length>0;)a=b.shift(),m.push(a),h(a),a.execute().then(e(a),f(a))["finally"](p(a))},z=function(){return s=_(s).sortBy("priority")},k=function(){return n=b(k,i()),l()},A=function(){return _(m).invoke("cancel")},q=function(a){return null!=_(s).findWhere({name:a})},o=function(a){var b;if(b=_(s).findWhere({name:a}),!b)throw"Job "+a+" is not a known job";return b},this.addJob=function(a){var b;if(n)throw"The scheduler is running.  Stop it before adding jobs.";b=r(a),b.validate(),s.push(b)},this.onNextRunOf=function(a){var b,e,f;return e=o(a),b=c.$new(!0),f=d.defer(),y(b,e,function(){var a,b;return b=arguments[0],a=2<=arguments.length?__slice.call(arguments,1):[],f.resolve.apply(f,a)}),v(b,e,function(){var a,b;return b=arguments[0],a=2<=arguments.length?__slice.call(arguments,1):[],f.reject.apply(f,a)}),f.promise["finally"](function(){return b.$destroy()}),f.promise},this.whenStarted=function(a,b,c){var d;return d=o(a),x(b,d,c)},this.whenSucceeded=function(a,b,c){var d;return d=o(a),y(b,d,c)},this.whenFailed=function(a,b,c){var d;return d=o(a),v(b,d,c)},this.whenFinished=function(a,b,c){var d;return d=o(a),w(b,d,c)},this.runNow=function(a){var b;b=o(a),b.makeOverdue(),l()},this.start=function(){console.debug("AdvancedPoller starting"),z(),k(),console.debug("AdvancedPoller started")},this.stop=function(){console.debug("AdvancedPoller stopping."),A(),n&&b.cancel(n),n=null,c.$$phase||c.$digest(),m=[],console.debug("AdvancedPoller stopped.")},this.setConcurrency=function(a){t=a},this.clearJobs=function(){if(null!=n)throw"Must be stopped to clear jobs";s=[]}}]);